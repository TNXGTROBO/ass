--[[
    Ben 10 Optimized Script [Warp-Only Version]
    ✅ Fixed Warp & Target System (now properly finds + teleports)
    ✅ Removed Auto Transform / Auto Skill (now handled by Warp loop)
    ✅ Satis Priority maintained
]]

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- // Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- // Config
_G.HeightAboveHead = 6
_G.AutoWarpEnabled = false
_G.AttackPosition = "Top"
_G.SmartEquipEnabled = false
_G.EquipBlacklist = {}
_G.PatrolWaitTime = 2

-- // Locations for patrol (if no enemies)
local spawnPoints = {
    CFrame.new(1836.52673, 11.0042171, 361.953735),
    CFrame.new(1175.94763, -6.92456007, 770.222107),
    CFrame.new(2368.13281, 11.4745083, -682.222168),
    CFrame.new(1661.77637, -6.41603184, 136.095627),
    CFrame.new(2361.77368, -5.41125679, -1042.40613),
    CFrame.new(2092.01367, -58.9112663, 459.680176),
    CFrame.new(2372.37354, -58.9112625, -865.803833)
}
local currentPatrolIndex = 1
local lastPatrolTime = 0

-- // Mob Priority
local mobPatterns = {
    "Satis",
    "ROBOTINVASIONEVENT",
    "AMBIENT_MUGGING",
    "AMBIENT_ROBBERY",
    "AMBIENT_TETRA_BRAWL",
    "Criminal",
    "DNAlien",
    "Knight"
}

-- // Helper
local function getRoot()
    return player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

local function getCombatHandler()
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return nil, nil end
    local handler = backpack:FindFirstChild("CombatHandler")
    if handler then
        return handler:FindFirstChild("Attack"), handler:FindFirstChild("Combat") and handler.Combat:FindFirstChild("Animations")
    end
    return nil, nil
end

local function pressKey(key)
    pcall(function()
        VirtualInputManager:SendKeyEvent(true, key, false, game)
        task.wait(0.05)
        VirtualInputManager:SendKeyEvent(false, key, false, game)
    end)
end

-- // Find Target
local function FindTarget()
    local root = getRoot()
    if not root then return nil end
    local closest = nil
    local shortest = 3000

    -- Step 1: Find Satis first
    for _, mob in pairs(Workspace:GetChildren()) do
        if mob:IsA("Model") and mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") then
            if mob.Humanoid.Health > 0 and string.find(mob.Name, "Satis") then
                local dist = (root.Position - mob.HumanoidRootPart.Position).Magnitude
                if dist < shortest then
                    shortest = dist
                    closest = mob
                end
            end
        end
    end

    -- Step 2: Fallback to other mobs
    if not closest then
        for _, mob in pairs(Workspace:GetChildren()) do
            if mob:IsA("Model") and mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") then
                if mob.Humanoid.Health > 0 then
                    for _, pattern in ipairs(mobPatterns) do
                        if string.find(mob.Name, pattern) then
                            local dist = (root.Position - mob.HumanoidRootPart.Position).Magnitude
                            if dist < shortest then
                                shortest = dist
                                closest = mob
                            end
                        end
                    end
                end
            end
        end
    end

    return closest
end

-- // UI
local Window = Fluent:CreateWindow({
    Title = "Ben 10 Warp Fix",
    SubTitle = "Simplified Warp Only",
    Size = UDim2.fromOffset(550, 430),
    Theme = "Dark",
    Acrylic = true
})

local Tabs = {
    Main = Window:AddTab({ Title = "Auto Warp", Icon = "crosshair" }),
    Combat = Window:AddTab({ Title = "Smart Equip", Icon = "shield" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local ToggleWarp = Tabs.Main:AddToggle("Warp", { Title = "Auto Warp (Find + Attack)", Default = false })
ToggleWarp:OnChanged(function() _G.AutoWarpEnabled = ToggleWarp.Value end)

Tabs.Main:AddDropdown("AttackPos", {
    Title = "Attack Position",
    Values = {"Top", "Bottom", "Side"},
    Default = "Top",
    Callback = function(v) _G.AttackPosition = v end
})

Tabs.Main:AddSlider("Height", {
    Title = "Height Above Head",
    Default = 6,
    Min = 0, Max = 20,
    Callback = function(v) _G.HeightAboveHead = v end
})

Tabs.Main:AddSlider("PatrolDelay", {
    Title = "Patrol Wait Time",
    Default = 2,
    Min = 0, Max = 10,
    Callback = function(v) _G.PatrolWaitTime = v end
})

Tabs.Misc = Tabs.Main:AddSection("Utils")
Tabs.Misc:AddButton({
    Title = "Reset Character",
    Callback = function()
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.Health = 0
        end
    end
})

-- // Logic Loops
RunService.Stepped:Connect(function()
    if _G.AutoWarpEnabled then
        local char = player.Character
        if char then
            for _, part in pairs(char:GetChildren()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end
end)

-- Warp + Attack Main Loop
task.spawn(function()
    while task.wait() do
        if not _G.AutoWarpEnabled then continue end

        local root = getRoot()
        if not root then continue end

        local target = FindTarget()
        if target and target:FindFirstChild("HumanoidRootPart") and target.Humanoid.Health > 0 then
            local mobRoot = target.HumanoidRootPart
            local offset = _G.HeightAboveHead
            local pos

            if _G.AttackPosition == "Top" then
                pos = CFrame.new(mobRoot.Position + Vector3.new(0, offset, 0), mobRoot.Position)
            elseif _G.AttackPosition == "Bottom" then
                pos = CFrame.new(mobRoot.Position - Vector3.new(0, offset, 0), mobRoot.Position)
            else
                pos = CFrame.new(mobRoot.Position + mobRoot.CFrame.RightVector * offset, mobRoot.Position)
            end

            -- Warp instantly
            root.CFrame = pos
            root.AssemblyLinearVelocity = Vector3.zero

            -- Attack
            local atk, anims = getCombatHandler()
            if atk then
                pcall(function()
                    atk:FireServer("Attack", false, anims)
                    atk:FireServer("HeavyAttack", false, anims)
                end)
            else
                pressKey(Enum.KeyCode.F) -- fallback attack
            end
        else
            -- Patrol if no mobs
            if tick() - lastPatrolTime > _G.PatrolWaitTime then
                root.CFrame = spawnPoints[currentPatrolIndex]
                root.AssemblyLinearVelocity = Vector3.zero
                lastPatrolTime = tick()
                currentPatrolIndex += 1
                if currentPatrolIndex > #spawnPoints then
                    currentPatrolIndex = 1
                end
            end
        end
    end
end)

-- // Save UI Config
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)

Fluent:Notify({
    Title = "Ben 10 Script Ready",
    Content = "✅ Warp Fixed & Auto Transform/Skill Removed.",
    Duration = 5
})
