--[[
    Ben 10 Fixed & Merged [Fluent UI]
    Fixes:
    - Warping Logic (Imported from working script)
    - Attack Logic (Dynamic Remote Handler)
    - Target Finding (Folder specific search)
    - Added Tool Manager (To fix holding items issue)
]]

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- // Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")
local VirtualUser = game:GetService("VirtualUser")

local player = Players.LocalPlayer

-- // Configuration (Global)
_G.AutoFarm = false
_G.AutoTransform = true
_G.Height = 5 -- ความสูงเหนือหัวมอน
_G.PatrolDelay = 2
_G.UnequipTools = true -- เลือกไม่ถือของ

-- // Logic Variables from Working Script
local currentPatrolIndex = 1
local spawnPoints = {
    CFrame.new(1836.5, 11.0, 361.9),
    CFrame.new(1175.9, -6.9, 770.2),
    CFrame.new(2368.1, 11.4, -682.2),
    CFrame.new(1661.7, -6.4, 136.0),
    CFrame.new(2361.7, -5.4, -1042.4),
    CFrame.new(2092.0, -58.9, 459.6),
    CFrame.new(2372.3, -58.9, -865.8)
}

-- Folder Patterns from the working script
local folderPatterns = {
    "ROBOTINVASIONEVENT:*",
    "AMBIENT_MUGGING:*",
    "AMBIENT_ROBBERY:*",
    "AMBIENT_TETRA_BRAWL:*",
}

-- // Helper Functions

local function pressKey(keyCode)
    VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
end

local function getRoot()
    return player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

local function getHumanoid()
    return player.Character and player.Character:FindFirstChild("Humanoid")
end

local function isHuman()
    local char = player.Character
    if not char then return false end
    local alienAttr = char:GetAttribute("Alien")
    return alienAttr == "Human" or alienAttr == nil
end

local function FolderMatches(name, pattern)
    if pattern:sub(-1) == "*" then
        return name:sub(1, #pattern - 1) == pattern:sub(1, -2)
    else
        return name == pattern
    end
end

-- ระบบหามอนสเตอร์แบบใหม่ (อิงจาก Script ที่ทำงานได้)
local function FindBestTarget()
    local bestTarget = nil
    
    -- ค้นหาใน Folder Events ก่อน (Priority)
    for _, folder in pairs(Workspace:GetChildren()) do
        for _, pattern in ipairs(folderPatterns) do
            if FolderMatches(folder.Name, pattern) then
                for _, obj in pairs(folder:GetChildren()) do
                    if obj:IsA("Model") and obj:FindFirstChild("HumanoidRootPart") and obj:FindFirstChild("Humanoid") then
                        if obj.Humanoid.Health > 0 then
                            -- เจอตัวแรกเอาเลย (หรือจะเพิ่ม Logic ระยะทางก็ได้)
                            return obj 
                        end
                    end
                end
            end
        end
    end
    
    -- ถ้าไม่เจอใน Event ให้หาทั่วไป (Satis/DNAlien etc.)
    local fallbackPatterns = {"Criminal", "DNAlien", "Knight", "Satis", "Boss"}
    local maxDist = 9999
    local root = getRoot()
    if not root then return nil end

    for _, model in pairs(Workspace:GetChildren()) do
        if model:IsA("Model") and model:FindFirstChild("Humanoid") and model:FindFirstChild("HumanoidRootPart") then
            if model.Humanoid.Health > 0 and model.Name ~= player.Name then
                local isMob = false
                for _, pat in pairs(fallbackPatterns) do
                    if string.find(model.Name, pat) then isMob = true break end
                end
                
                if isMob then
                    local dist = (root.Position - model.HumanoidRootPart.Position).Magnitude
                    if dist < maxDist then
                        maxDist = dist
                        bestTarget = model
                    end
                end
            end
        end
    end
    
    return bestTarget
end

-- ระบบดึง Combat Handler แบบใหม่ (แก้ปัญหาตีไม่เข้า)
local function GetAttackRemote()
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return nil end
    
    local ch = backpack:FindFirstChild("CombatHandler")
    if not ch then return nil end

    local attack = ch:FindFirstChild("Attack")
    local combat = ch:FindFirstChild("Combat")
    local anims = combat and combat:FindFirstChild("Animations")
    
    if attack and anims then
        return attack, anims
    end
    return nil
end

-- // UI Setup
local Window = Fluent:CreateWindow({
    Title = "Ben 10 Fixed [Working Warp]",
    SubTitle = "Merged Logic",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main Farm", Icon = "sword" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Options = Fluent.Options

-- [[ MAIN TAB ]] --

local ToggleFarm = Tabs.Main:AddToggle("AutoFarm", {Title = "Enable Auto Farm", Default = false })
ToggleFarm:OnChanged(function()
    _G.AutoFarm = Options.AutoFarm.Value
end)

local ToggleTrans = Tabs.Main:AddToggle("AutoTrans", {Title = "Auto Transform", Default = true })
ToggleTrans:OnChanged(function() _G.AutoTransform = Options.AutoTrans.Value end)

local ToggleUnequip = Tabs.Main:AddToggle("UnequipTools", {Title = "Auto Unequip Tools", Description = "เก็บของเข้ากระเป๋าเวลาฟาร์ม (แก้บัคถือของ)", Default = true })
ToggleUnequip:OnChanged(function() _G.UnequipTools = Options.UnequipTools.Value end)

Tabs.Main:AddParagraph({
    Title = "Status",
    Content = "Logic Replaced: Using Folder Search + Dynamic Combat Handler.\nWarping should work now."
})

-- [[ SETTINGS TAB ]] --

Tabs.Settings:AddSlider("SliderDist", {
    Title = "Height Above Mob",
    Default = 5, Min = -10, Max = 15, Rounding = 1,
    Callback = function(Value) _G.Height = Value end
})

Tabs.Settings:AddSlider("SliderPatrol", {
    Title = "Patrol Delay",
    Description = "Time to wait after patrol warp",
    Default = 2, Min = 0.5, Max = 5, Rounding = 0.5,
    Callback = function(Value) _G.PatrolDelay = Value end
})

-- [[ MAIN LOGIC LOOP ]] --

task.spawn(function()
    while true do
        if _G.AutoFarm then
            local root = getRoot()
            local hum = getHumanoid()

            if root and hum and hum.Health > 0 then
                
                -- 1. Manage Tools (Unequip Logic)
                if _G.UnequipTools then
                    local char = player.Character
                    if char then
                        for _, item in pairs(char:GetChildren()) do
                            if item:IsA("Tool") then
                                item.Parent = player.Backpack
                            end
                        end
                    end
                end

                -- 2. Transform Logic
                if _G.AutoTransform and isHuman() then
                    pressKey(Enum.KeyCode.V)
                    task.wait(0.5)
                    pressKey(Enum.KeyCode.C)
                    task.wait(0.2)
                    -- Spam confirm
                    for i=1, 3 do pressKey(Enum.KeyCode.C) task.wait(0.1) end
                    task.wait(1.5)
                else
                    -- 3. Farm Logic (Warp & Attack)
                    local target = FindBestTarget()
                    
                    if target and target:FindFirstChild("HumanoidRootPart") and target.Humanoid.Health > 0 then
                        local tRoot = target.HumanoidRootPart
                        
                        -- WARP LOGIC (Continuous Lock)
                        -- ใช้วิธี Lock แบบ Script ที่ทำงานได้
                        pcall(function()
                            root.CFrame = CFrame.new(tRoot.Position + Vector3.new(0, _G.Height, 0), tRoot.Position)
                            root.AssemblyLinearVelocity = Vector3.zero
                        end)
                        
                        -- ATTACK LOGIC (Dynamic Remote)
                        local atkRemote, anims = GetAttackRemote()
                        if atkRemote then
                            -- ตีแบบสลับ Heavy Attack เหมือนโค้ดอ้างอิง
                            pcall(function()
                                atkRemote:FireServer("Attack", false, anims)
                            end)
                        else
                            -- สำรองถ้าหา Remote ไม่เจอ (Click)
                            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
                            task.wait()
                            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                        end

                        -- Skill Spam (Optional)
                        local dist = (root.Position - tRoot.Position).Magnitude
                        if dist < 50 then
                            pressKey(Enum.KeyCode.Z)
                            pressKey(Enum.KeyCode.X)
                            pressKey(Enum.KeyCode.C)
                            pressKey(Enum.KeyCode.B)
                        end
                        
                    else
                        -- 4. PATROL (No Target)
                        root.CFrame = spawnPoints[currentPatrolIndex]
                        root.AssemblyLinearVelocity = Vector3.zero
                        
                        -- รอ Spawn
                        task.wait(_G.PatrolDelay)
                        
                        -- เช็คอีกทีว่ามีมอนเกิดไหม ถ้าไม่มีให้เปลี่ยนจุด
                        if not FindBestTarget() then
                            currentPatrolIndex = currentPatrolIndex + 1
                            if currentPatrolIndex > #spawnPoints then currentPatrolIndex = 1 end
                        end
                    end
                end
            end
        end
        task.wait(0.05) -- Fast tick
    end
end)

-- [[ ANTI-AFK ]] --
task.spawn(function()
    player.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end)

-- [[ NOCLIP ]] --
RunService.Stepped:Connect(function()
    if _G.AutoFarm then
        local char = player.Character
        if char then
            for _, v in pairs(char:GetChildren()) do
                if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
            end
        end
    end
end)

-- // Finalize
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
Window:SelectTab(1)

Fluent:Notify({
    Title = "Ben 10 Merged Script",
    Content = "Logic Updated: Warp & Folder Search Fixed.",
    Duration = 5
})
