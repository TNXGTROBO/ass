--[[
    Ben 10 Mobile Optimized Script [Rayfield Edition]
    Library: Rayfield (Stable & Mobile Friendly)
    Fixes:
    - Replaced Orion with Rayfield for better Dropdown support.
    - Full Multi-Select support for Blacklist.
]]

-- รอให้เกมโหลดเสร็จ
if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- // Load Rayfield Library (เสถียรกว่าบนมือถือ)
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- // Window Setup
local Window = Rayfield:CreateWindow({
    Name = "Ben 10 Fix [Rayfield Mobile]",
    LoadingTitle = "Ben 10 Mobile Hub",
    LoadingSubtitle = "by YourName",
    ConfigurationSaving = {
        Enabled = false, -- ปิดเซฟ Config เพื่อป้องกันบั๊ก
        FolderName = nil, 
        FileName = "Ben10Hub"
    },
    Discord = {
        Enabled = false,
        Invite = "", 
        RememberJoins = true 
    },
    KeySystem = false, -- ปิด Key System
})

-- // Services & Variables
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")
local player = Players.LocalPlayer

-- Global Configs
_G.HeightAboveHead = 6
_G.AutoWarpEnabled = false
_G.AutoTransform = false
_G.AttackPosition = "Top"
_G.SmartEquipEnabled = false 
_G.EquipBlacklist = {} -- Table สำหรับเก็บรายชื่อไอเทมที่ไม่ต้องการถือ
_G.SkillSpam = { Z = false, X = false, C = false, B = false }
_G.SkillSpamEnabled = false
_G.PatrolWaitTime = 2 

-- // Logic Variables
local spawnPoints = {
    CFrame.new(1836.52673, 11.0042171, 361.953735),
    CFrame.new(1175.94763, -6.92456007, 770.222107),
    CFrame.new(2368.13281, 11.4745083, -682.222168),
    CFrame.new(1661.77637, -6.41603184, 136.095627),
    CFrame.new(2361.77368, -5.41125679, -1042.40613),
    CFrame.new(2092.01367, -58.9112663, 459.680176),
    CFrame.new(2372.37354, -58.9112625, -865.803833)
}
local currentPatrolIndex = 1
local lastPatrolTime = 0

local mobPatterns = {
    "ROBOTINVASIONEVENT", 
    "AMBIENT_MUGGING", 
    "AMBIENT_ROBBERY", 
    "AMBIENT_TETRA_BRAWL",
    "Criminal", 
    "DNAlien",  
    "Knight",
    "Satis"
}

-- // Helper Functions (Logic เดิมของคุณ)
local function pressKeyReal(keyCode)
    pcall(function()
        VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
        task.wait(0.05)
        VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
    end)
end

local function getCombatHandler()
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return nil, nil end
    local handler = backpack:FindFirstChild("CombatHandler")
    if handler then
        return handler:FindFirstChild("Attack"), handler:FindFirstChild("Combat") and handler.Combat:FindFirstChild("Animations")
    end
    return nil, nil
end

local function getRoot()
    return player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

local function getInventoryTools()
    local tools = {}
    local function scan(container)
        for _, v in pairs(container:GetChildren()) do
            if v:IsA("Tool") and not table.find(tools, v.Name) then
                table.insert(tools, v.Name)
            end
        end
    end
    if player.Backpack then scan(player.Backpack) end
    if player.Character then scan(player.Character) end
    
    if #tools == 0 then
        return {"No Items Found"} -- กัน Dropdown ว่าง
    end
    return tools
end

local function FindTarget()
    local closest = nil
    local maxDist = 3000 
    local root = getRoot()
    if not root then return nil end

    for _, folder in pairs(Workspace:GetChildren()) do
        if folder:IsA("Model") and folder:FindFirstChild("HumanoidRootPart") and folder:FindFirstChild("Humanoid") and folder.Humanoid.Health > 0 then
            local name = folder.Name
            for _, pattern in ipairs(mobPatterns) do
                if string.find(name, pattern) or string.match(name, pattern) then
                      local dist = (root.Position - folder.HumanoidRootPart.Position).Magnitude
                      if dist < maxDist then
                          maxDist = dist
                          closest = folder
                      end
                end
            end
        end
    end
    return closest
end

-- // Main UI Tabs

local MainTab = Window:CreateTab("Auto Farm", 4483345998)
local CombatTab = Window:CreateTab("Combat & Items", 4483345998)
local SkillTab = Window:CreateTab("Skills", 4483345998)
local MiscTab = Window:CreateTab("Misc", 4483345998)

-- // Tab 1: Auto Farm
MainTab:CreateToggle({
    Name = "Auto Warp + Kill (with Patrol)",
    CurrentValue = false,
    Flag = "AutoWarp",
    Callback = function(Value)
        _G.AutoWarpEnabled = Value
    end,
})

MainTab:CreateDropdown({
    Name = "Attack Position",
    Options = {"Top", "Bottom", "Side"},
    CurrentOption = {"Top"},
    MultipleOptions = false,
    Callback = function(Option)
        _G.AttackPosition = Option[1]
    end,
})

MainTab:CreateSlider({
    Name = "Distance (Studs)",
    Range = {0, 20},
    Increment = 1,
    Suffix = "Studs",
    CurrentValue = 6,
    Callback = function(Value)
        _G.HeightAboveHead = Value
    end,
})

MainTab:CreateSlider({
    Name = "Patrol Wait Time",
    Range = {0, 10},
    Increment = 0.5,
    Suffix = "Secs",
    CurrentValue = 2,
    Callback = function(Value)
        _G.PatrolWaitTime = Value
    end,
})

-- // Tab 2: Combat & Items (Fixed Dropdown Here)

CombatTab:CreateToggle({
    Name = "Auto Smart Equip Tool",
    CurrentValue = false,
    Callback = function(Value)
        _G.SmartEquipEnabled = Value
    end,
})

local DropdownItems = getInventoryTools()
local BlacklistDropdown -- ประกาศตัวแปรไว้ก่อนเพื่อใช้ Refresh ทีหลัง

BlacklistDropdown = CombatTab:CreateDropdown({
    Name = "Blacklist Items (Multi-Select)",
    Options = DropdownItems,
    CurrentOption = {},
    MultipleOptions = true, -- !! เปิดใช้ Multi-Select ของ Rayfield !!
    Flag = "BlacklistDropdown",
    Callback = function(Options)
        -- Rayfield ส่งค่ากลับมาเป็น Table ของไอเทมที่เลือก
        _G.EquipBlacklist = Options
        
        -- Debug Print
        print("Blacklist Updated:")
        for _, v in pairs(Options) do
            print("- " .. v)
        end
    end,
})

CombatTab:CreateButton({
    Name = "Refresh Inventory List",
    Callback = function()
        local newTools = getInventoryTools()
        -- ใช้ฟังก์ชัน Refresh ของ Rayfield
        BlacklistDropdown:Refresh(newTools) 
    end,
})

-- // Tab 3: Skills
SkillTab:CreateToggle({ Name = "Enable Skill Spam", CurrentValue = false, Callback = function(v) _G.SkillSpamEnabled = v end })
SkillTab:CreateToggle({ Name = "Auto Z", CurrentValue = false, Callback = function(v) _G.SkillSpam.Z = v end })
SkillTab:CreateToggle({ Name = "Auto X", CurrentValue = false, Callback = function(v) _G.SkillSpam.X = v end })
SkillTab:CreateToggle({ Name = "Auto C", CurrentValue = false, Callback = function(v) _G.SkillSpam.C = v end })
SkillTab:CreateToggle({ Name = "Auto B", CurrentValue = false, Callback = function(v) _G.SkillSpam.B = v end })
SkillTab:CreateToggle({ Name = "Auto Transform", CurrentValue = false, Callback = function(v) _G.AutoTransform = v end })

-- // Tab 4: Misc
MiscTab:CreateButton({
    Name = "Reset Character",
    Callback = function()
         if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.Health = 0
        end
     end    
})

-- // Logic Loops (ทำงานอยู่เบื้องหลังเหมือนเดิม)

-- NoClip
RunService.Stepped:Connect(function()
    if _G.AutoWarpEnabled then
        local char = player.Character
        if char then
            for _, part in pairs(char:GetChildren()) do
                if part:IsA("BasePart") and part.CanCollide then
                    part.CanCollide = false
                end
            end
        end
    end
end)

-- Skill Spam
task.spawn(function()
    while true do
        if _G.SkillSpamEnabled then
            local target = FindTarget()
            local root = getRoot()
            if target and root and (root.Position - target.HumanoidRootPart.Position).Magnitude < 50 then
                if _G.SkillSpam.Z then pressKeyReal(Enum.KeyCode.Z) end
                if _G.SkillSpam.X then pressKeyReal(Enum.KeyCode.X) end
                if _G.SkillSpam.C then pressKeyReal(Enum.KeyCode.C) end
                if _G.SkillSpam.B then pressKeyReal(Enum.KeyCode.B) end
            end
        end
        task.wait(0.5)
    end
end)

-- Smart Equip (Logic เดิม แต่ใช้ Blacklist จาก Rayfield)
task.spawn(function()
    while true do
        if _G.SmartEquipEnabled then
            local char = player.Character
            if char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
                local currentTool = char:FindFirstChildWhichIsA("Tool")
                
                if not currentTool then
                    local backpack = player:FindFirstChild("Backpack")
                    if backpack then
                        for _, tool in pairs(backpack:GetChildren()) do
                            if tool:IsA("Tool") then
                                local isBlacklisted = false
                                
                                -- เช็คจาก _G.EquipBlacklist (ซึ่งตอนนี้เป็น Table จาก Rayfield แล้ว)
                                if _G.EquipBlacklist and type(_G.EquipBlacklist) == "table" then
                                    for _, blockedName in pairs(_G.EquipBlacklist) do
                                        if tool.Name == blockedName then
                                            isBlacklisted = true
                                            break
                                        end
                                    end
                                end
                                
                                if not isBlacklisted then
                                    char.Humanoid:EquipTool(tool)
                                    break 
                                end
                            end
                        end
                    end
                end
            end
        end
        task.wait(1)
    end
end)

-- Auto Transform
task.spawn(function()
    while true do
        if _G.AutoTransform then
            local char = player.Character
            if char and (char:GetAttribute("Alien") == "Human" or not char:GetAttribute("Alien")) then
                pressKeyReal(Enum.KeyCode.V)
                task.wait(2.5) 
                pressKeyReal(Enum.KeyCode.C)
                task.wait(0.2)
                pressKeyReal(Enum.KeyCode.C)
                task.wait(6)
            end
        end
        task.wait(1)
    end
end)

-- Auto Attack
task.spawn(function()
    while true do
        if _G.AutoWarpEnabled then
            local target = FindTarget() 
            if target then
                local atk, anims = getCombatHandler()
                if atk then
                    pcall(function()
                        atk:FireServer("Attack", false, anims)
                        atk:FireServer("HeavyAttack", false, anims)
                    end)
                else
                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
                    task.wait(0.05)
                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                end
            end
        end
        task.wait(0.15)
    end
end)

-- Auto Warp + Patrol Logic
task.spawn(function()
    while true do
        if _G.AutoWarpEnabled then
            local root = getRoot()
            local target = FindTarget()
             
            if root then
                if target and target:FindFirstChild("HumanoidRootPart") then
                    local mobRoot = target.HumanoidRootPart
                    local finalCF
                        
                    if _G.AttackPosition == "Top" then
                        finalCF = CFrame.new(mobRoot.Position + Vector3.new(0, _G.HeightAboveHead, 0), mobRoot.Position) * CFrame.Angles(math.rad(-90), 0, 0)
                    elseif _G.AttackPosition == "Bottom" then
                        finalCF = CFrame.new(mobRoot.Position - Vector3.new(0, _G.HeightAboveHead, 0), mobRoot.Position) * CFrame.Angles(math.rad(90), 0, 0)
                    elseif _G.AttackPosition == "Side" then
                        local backPos = mobRoot.CFrame * CFrame.new(0, 0, _G.HeightAboveHead)
                        finalCF = CFrame.lookAt(backPos.Position, mobRoot.Position)
                    end
                        
                    if finalCF then
                        root.CFrame = finalCF
                        root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                    end
                else
                    if tick() - lastPatrolTime > _G.PatrolWaitTime then
                        root.CFrame = spawnPoints[currentPatrolIndex]
                        root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                            
                        lastPatrolTime = tick()
                        currentPatrolIndex = currentPatrolIndex + 1
                        if currentPatrolIndex > #spawnPoints then
                            currentPatrolIndex = 1
                        end
                    end
                end
            end
        end
        task.wait() 
    end
end)

Rayfield:Notify({
    Title = "Script Loaded",
    Content = "Ben 10 Fix loaded successfully!",
    Duration = 5,
    Image = 4483345998,
})
