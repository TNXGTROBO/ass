--[[
    Ben 10 Optimized Script [Fluent UI] - FIXED & MERGED
    Update Log:
    - Merged ALL logic into one single Master Loop.
    - Transform Priority: Checks if Human -> Spams C -> Only then Attacks.
    - Patrol Fix: Now correctly cycles through 7 spawn points if no target is found.
    - Skill Fix: Skills fire only when near the target.
]]

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- // Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- // Config Variables
_G.HeightAboveHead = 6
_G.AutoWarpEnabled = false
_G.AutoTransform = false
_G.AttackPosition = "Top"
_G.SmartEquipEnabled = false 
_G.EquipBlacklist = {} 
_G.SkillSpam = { Z = false, X = false, C = false, B = false }
_G.SkillSpamEnabled = false
_G.PatrolWaitTime = 1.5 -- Reduced default wait time for snappier patrol

-- // Logic Data
local spawnPoints = {
    CFrame.new(1836.52673, 11.0042171, 361.953735),
    CFrame.new(1175.94763, -6.92456007, 770.222107),
    CFrame.new(2368.13281, 11.4745083, -682.222168),
    CFrame.new(1661.77637, -6.41603184, 136.095627),
    CFrame.new(2361.77368, -5.41125679, -1042.40613),
    CFrame.new(2092.01367, -58.9112663, 459.680176),
    CFrame.new(2372.37354, -58.9112625, -865.803833)
}
local currentPatrolIndex = 1
local lastPatrolTime = 0

local mobPatterns = {
    "ROBOTINVASIONEVENT", 
    "AMBIENT_MUGGING", 
    "AMBIENT_ROBBERY", 
    "AMBIENT_TETRA_BRAWL",
    "Criminal", 
    "DNAlien",  
    "Knight",
    "Satis",
    "Boss" -- Added general Boss keyword
}

-- // Helper Functions
local function pressKey(keyCode)
    VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
end

local function getCombatHandler()
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return nil, nil end
    local handler = backpack:FindFirstChild("CombatHandler")
    if handler then
        return handler:FindFirstChild("Attack"), handler:FindFirstChild("Combat") and handler.Combat:FindFirstChild("Animations")
    end
    return nil, nil
end

local function getRoot()
    return player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

local function isHuman()
    local char = player.Character
    if not char then return false end
    -- Check Attribute (Most reliable) or Name
    local alienAttr = char:GetAttribute("Alien")
    if alienAttr == "Human" or alienAttr == nil then
        return true
    end
    return false
end

local function getInventoryTools()
    local tools = {}
    local found = false
    
    local function scan(container)
        for _, v in pairs(container:GetChildren()) do
            if v:IsA("Tool") and not table.find(tools, v.Name) then
                table.insert(tools, v.Name)
                found = true
            end
        end
    end

    if player.Backpack then scan(player.Backpack) end
    if player.Character then scan(player.Character) end
    
    if not found then
        return {"No Items Found"} 
    end
    return tools
end

local function FindTarget()
    local closest = nil
    local maxDist = 5000 -- Search huge range
    local root = getRoot()
    if not root then return nil end

    for _, folder in pairs(Workspace:GetChildren()) do
        if folder:IsA("Model") and folder:FindFirstChild("HumanoidRootPart") and folder:FindFirstChild("Humanoid") and folder.Humanoid.Health > 0 then
            local name = folder.Name
            -- Don't target self
            if name ~= player.Name then
                for _, pattern in ipairs(mobPatterns) do
                    if string.find(name, pattern) or string.match(name, pattern) then
                          local dist = (root.Position - folder.HumanoidRootPart.Position).Magnitude
                          if dist < maxDist then
                              maxDist = dist
                              closest = folder
                          end
                    end
                end
            end
        end
    end
    return closest
end

-- // UI Window Setup
local Window = Fluent:CreateWindow({
    Title = "Ben 10 Fixed (Merged Logic)",
    SubTitle = "Transform -> Warp -> Kill",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Auto Farm", Icon = "sword" }),
    Combat = Window:AddTab({ Title = "Combat & Items", Icon = "backpack" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "settings" }),
    Settings = Window:AddTab({ Title = "UI Settings", Icon = "settings" })
}

local Options = Fluent.Options

-- [[ MAIN TAB ]] --

local ToggleAutoWarp = Tabs.Main:AddToggle("AutoWarp", {Title = "Enable Auto Farm (Loop)", Default = false })
ToggleAutoWarp:OnChanged(function()
    _G.AutoWarpEnabled = Options.AutoWarp.Value
end)

local DropAttackPos = Tabs.Main:AddDropdown("AttackPos", {
    Title = "Attack Position",
    Values = {"Top", "Bottom", "Side"},
    Multi = false,
    Default = "Top",
})
DropAttackPos:OnChanged(function(Value)
    _G.AttackPosition = Value
end)

local SliderDist = Tabs.Main:AddSlider("Distance", {
    Title = "Distance (Studs)",
    Description = "Height above mob head",
    Default = 6,
    Min = 0,
    Max = 20,
    Rounding = 1,
    Callback = function(Value)
        _G.HeightAboveHead = Value
    end
})

local SliderPatrol = Tabs.Main:AddSlider("PatrolWait", {
    Title = "Patrol Wait Time",
    Description = "Time before warping to next spawn if no mobs",
    Default = 1.5,
    Min = 0,
    Max = 10,
    Rounding = 1,
    Callback = function(Value)
        _G.PatrolWaitTime = Value
    end
})

-- [[ COMBAT TAB ]] --

local ToggleSmartEquip = Tabs.Combat:AddToggle("SmartEquip", {Title = "Auto Smart Equip Tool", Default = false })
ToggleSmartEquip:OnChanged(function()
    _G.SmartEquipEnabled = Options.SmartEquip.Value
end)

local currentTools = getInventoryTools()
local MultiDropdownBlacklist = Tabs.Combat:AddDropdown("BlacklistDrop", {
    Title = "Blacklist Items",
    Description = "Select items to NOT equip",
    Values = currentTools,
    Multi = true,
    Default = {},
})

MultiDropdownBlacklist:OnChanged(function(Value)
    local list = {}
    for key, state in pairs(Value) do
        if state then table.insert(list, key) end
    end
    _G.EquipBlacklist = list
end)

Tabs.Combat:AddButton({
    Title = "Refresh Tool List",
    Callback = function()
        local newTools = getInventoryTools()
        MultiDropdownBlacklist:SetValues(newTools)
        Fluent:Notify({Title = "Tools Refreshed", Content = "Found " .. #newTools .. " items.", Duration = 3})
    end
})

Tabs.Combat:AddSection("Auto Skills")

local ToggleSkillSpam = Tabs.Combat:AddToggle("SkillSpam", {Title = "Enable Auto Skills", Default = false })
ToggleSkillSpam:OnChanged(function() _G.SkillSpamEnabled = Options.SkillSpam.Value end)

local ToggleZ = Tabs.Combat:AddToggle("AutoZ", {Title = "Use Z", Default = false })
ToggleZ:OnChanged(function() _G.SkillSpam.Z = Options.AutoZ.Value end)

local ToggleX = Tabs.Combat:AddToggle("AutoX", {Title = "Use X", Default = false })
ToggleX:OnChanged(function() _G.SkillSpam.X = Options.AutoX.Value end)

local ToggleC = Tabs.Combat:AddToggle("AutoC", {Title = "Use C", Default = false })
ToggleC:OnChanged(function() _G.SkillSpam.C = Options.AutoC.Value end)

local ToggleB = Tabs.Combat:AddToggle("AutoB", {Title = "Use B", Default = false })
ToggleB:OnChanged(function() _G.SkillSpam.B = Options.AutoB.Value end)

local ToggleTransform = Tabs.Combat:AddToggle("AutoTrans", {Title = "Auto Transform (Priority)", Default = false })
ToggleTransform:OnChanged(function() _G.AutoTransform = Options.AutoTrans.Value end)


-- [[ MISC TAB ]] --

Tabs.Misc:AddButton({
    Title = "Reset Character",
    Callback = function()
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.Health = 0
        end
    end
})


-- [[ LOGIC LOOPS ]] --

-- 1. NoClip Loop (Prevents getting stuck)
RunService.Stepped:Connect(function()
    if _G.AutoWarpEnabled then
        local char = player.Character
        if char then
            for _, part in pairs(char:GetChildren()) do
                if part:IsA("BasePart") and part.CanCollide then
                    part.CanCollide = false
                end
            end
        end
    end
end)

-- 2. Smart Equip (Passive)
task.spawn(function()
    while true do
        if _G.SmartEquipEnabled then
            local char = player.Character
            if char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
                local currentTool = char:FindFirstChildWhichIsA("Tool")
                if not currentTool then
                    local backpack = player:FindFirstChild("Backpack")
                    if backpack then
                        for _, tool in pairs(backpack:GetChildren()) do
                            if tool:IsA("Tool") then
                                local isBlacklisted = false
                                if _G.EquipBlacklist then
                                    for _, blockedName in pairs(_G.EquipBlacklist) do
                                        if tool.Name == blockedName then isBlacklisted = true break end
                                    end
                                end
                                if not isBlacklisted then
                                    char.Humanoid:EquipTool(tool)
                                    break 
                                end
                            end
                        end
                    end
                end
            end
        end
        task.wait(1)
    end
end)

-- 3. THE MASTER LOOP (Transform -> Warp -> Kill -> Patrol)
task.spawn(function()
    while true do
        if _G.AutoWarpEnabled then
            local root = getRoot()
            local char = player.Character
            
            if root and char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
                
                -- [[ STEP 1: PRIORITY TRANSFORM ]] --
                if _G.AutoTransform and isHuman() then
                    -- If we are human, STOP warping, STOP attacking. Just Transform.
                    -- Logic: Press V once to open, Spam C to transform.
                    
                    pressKey(Enum.KeyCode.V) -- Open Omnitrix
                    task.wait(0.2)
                    pressKey(Enum.KeyCode.C) -- Select/Transform
                    
                    -- Quick loop to spam C
                    for i = 1, 5 do
                        pressKey(Enum.KeyCode.C)
                        task.wait(0.1)
                    end
                    
                    task.wait(0.5) -- Wait for animation slightly
                    -- Continue loop will restart logic to check if we are still human
                    
                else
                    -- [[ STEP 2: FIND TARGET ]] --
                    local target = FindTarget()
                    
                    if target and target:FindFirstChild("HumanoidRootPart") then
                        -- [[ STEP 3: WARP & KILL ]] --
                        local mobRoot = target.HumanoidRootPart
                        local finalCF
                        
                        -- Calculate Position
                        if _G.AttackPosition == "Top" then
                            finalCF = CFrame.new(mobRoot.Position + Vector3.new(0, _G.HeightAboveHead, 0), mobRoot.Position) * CFrame.Angles(math.rad(-90), 0, 0)
                        elseif _G.AttackPosition == "Bottom" then
                            finalCF = CFrame.new(mobRoot.Position - Vector3.new(0, _G.HeightAboveHead, 0), mobRoot.Position) * CFrame.Angles(math.rad(90), 0, 0)
                        else -- Side
                            local backPos = mobRoot.CFrame * CFrame.new(0, 0, _G.HeightAboveHead)
                            finalCF = CFrame.lookAt(backPos.Position, mobRoot.Position)
                        end
                        
                        -- Apply Warp
                        if finalCF then
                            root.CFrame = finalCF
                            root.AssemblyLinearVelocity = Vector3.new(0,0,0) -- Stop falling
                        end
                        
                        -- Attack Logic (Only if close)
                        if (root.Position - mobRoot.Position).Magnitude < 60 then
                            
                            -- Regular Attack
                            local atk, anims = getCombatHandler()
                            if atk then
                                pcall(function()
                                    atk:FireServer("Attack", false, anims)
                                end)
                            else
                                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
                                task.wait()
                                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                            end

                            -- Auto Skills (Embedded inside Attack)
                            if _G.SkillSpamEnabled then
                                if _G.SkillSpam.Z then pressKey(Enum.KeyCode.Z) end
                                if _G.SkillSpam.X then pressKey(Enum.KeyCode.X) end
                                if _G.SkillSpam.C then pressKey(Enum.KeyCode.C) end
                                if _G.SkillSpam.B then pressKey(Enum.KeyCode.B) end
                            end
                        end
                        
                    else
                        -- [[ STEP 4: PATROL (If No Target Found) ]] --
                        if tick() - lastPatrolTime > _G.PatrolWaitTime then
                            -- Warp to Patrol Point
                            root.CFrame = spawnPoints[currentPatrolIndex]
                            root.AssemblyLinearVelocity = Vector3.new(0,0,0)
                            
                            -- Increment Index
                            currentPatrolIndex = currentPatrolIndex + 1
                            if currentPatrolIndex > #spawnPoints then
                                currentPatrolIndex = 1
                            end
                            
                            lastPatrolTime = tick()
                        end
                    end
                end
            end
        end
        task.wait() -- Run fast but yield to prevent crash
    end
end)

-- // Finalize UI
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("FluentBen10Fixed")
SaveManager:SetFolder("FluentBen10Fixed/Configs")

InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)

Fluent:Notify({
    Title = "Ben 10 Script Loaded",
    Content = "Logic Merged. Enable Auto Farm to Start.",
    Duration = 5
})
