--[[
    Ben 10 Optimized & Fixed [Fluent UI]
    Version: FULL MERGE & FIX
    
    Logic Flow:
    1. Check Auto Farm ON?
    2. Is Human? -> Transform first.
    3. Look for Target.
    4. Target Found? -> Warp -> Attack + Auto Skill (Merged).
    5. No Target? -> Warp to next Patrol Point -> Wait for spawn -> Repeat.
]]

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- // Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- // Configuration (Defaults)
_G.AutoFarm = false
_G.AutoTransform = true -- Default True inside logic
_G.AttackPosition = "Top"
_G.Height = 6
_G.UseSkills = { Z = true, X = true, C = true, B = true } -- Default all true
_G.PatrolDelay = 2 -- Time to wait after warping to patrol point before checking mobs

-- // Logic Variables
local currentPatrolIndex = 1
local spawnPoints = {
    CFrame.new(1836.5, 11.0, 361.9),
    CFrame.new(1175.9, -6.9, 770.2),
    CFrame.new(2368.1, 11.4, -682.2),
    CFrame.new(1661.7, -6.4, 136.0),
    CFrame.new(2361.7, -5.4, -1042.4),
    CFrame.new(2092.0, -58.9, 459.6),
    CFrame.new(2372.3, -58.9, -865.8)
}

local mobPatterns = {
    "ROBOTINVASIONEVENT", "AMBIENT_MUGGING", "AMBIENT_ROBBERY", 
    "AMBIENT_TETRA_BRAWL", "Criminal", "DNAlien", "Knight", "Satis", "Boss"
}

-- // Helper Functions

local function pressKey(keyCode)
    VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
end

local function getRoot()
    return player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

local function getHumanoid()
    return player.Character and player.Character:FindFirstChild("Humanoid")
end

local function isHuman()
    local char = player.Character
    if not char then return false end
    local alienAttr = char:GetAttribute("Alien")
    -- Return true if attribute is Human or nil (some games use nil for base char)
    return alienAttr == "Human" or alienAttr == nil
end

local function FindClosestTarget()
    local closest = nil
    local maxDist = 9999 -- Infinite range search
    local root = getRoot()
    if not root then return nil end

    for _, model in pairs(Workspace:GetChildren()) do
        if model:IsA("Model") and model:FindFirstChild("Humanoid") and model:FindFirstChild("HumanoidRootPart") then
            if model.Humanoid.Health > 0 and model.Name ~= player.Name then
                local isMob = false
                for _, pattern in pairs(mobPatterns) do
                    if string.find(model.Name, pattern) or string.match(model.Name, pattern) then
                        isMob = true
                        break
                    end
                end
                
                if isMob then
                    local dist = (root.Position - model.HumanoidRootPart.Position).Magnitude
                    if dist < maxDist then
                        maxDist = dist
                        closest = model
                    end
                end
            end
        end
    end
    return closest
end

local function CombatSequence(target)
    if not target or not target:FindFirstChild("HumanoidRootPart") then return end
    
    -- 1. Get Combat Handler (Remote)
    local backpack = player:FindFirstChild("Backpack")
    local attackRemote = nil
    local animations = nil
    
    if backpack and backpack:FindFirstChild("CombatHandler") then
        local handler = backpack.CombatHandler
        attackRemote = handler:FindFirstChild("Attack")
        if handler:FindFirstChild("Combat") then
            animations = handler.Combat:FindFirstChild("Animations")
        end
    end

    -- 2. Attack & Skill Spam
    if _G.AutoFarm then
        -- Normal Attack (Try Remote first, then Click)
        if attackRemote then
            pcall(function() attackRemote:FireServer("Attack", false, animations) end)
        else
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
            task.wait()
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
        end

        -- Auto Skills (Merged here)
        local dist = (getRoot().Position - target.HumanoidRootPart.Position).Magnitude
        if dist < 60 then -- Only use skills if close
            if _G.UseSkills.Z then pressKey(Enum.KeyCode.Z) end
            if _G.UseSkills.X then pressKey(Enum.KeyCode.X) end
            if _G.UseSkills.C then pressKey(Enum.KeyCode.C) end
            if _G.UseSkills.B then pressKey(Enum.KeyCode.B) end
        end
    end
end

-- // UI Setup
local Window = Fluent:CreateWindow({
    Title = "Ben 10 Fixed [Merged Logic]",
    SubTitle = "Auto Farm All-in-One",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main Farm", Icon = "sword" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Options = Fluent.Options

-- [[ MAIN TAB ]] --

local ToggleFarm = Tabs.Main:AddToggle("AutoFarm", {Title = "Enable Auto Farm", Default = false })
ToggleFarm:OnChanged(function()
    _G.AutoFarm = Options.AutoFarm.Value
end)

Tabs.Main:AddParagraph({
    Title = "How it works:",
    Content = "1. Checks if Human -> Transforms\n2. Finds Target -> Warps & Kills\n3. No Target? -> Patrols -> Repeats"
})

local ToggleTrans = Tabs.Main:AddToggle("AutoTrans", {Title = "Auto Transform (Priority)", Default = true })
ToggleTrans:OnChanged(function() _G.AutoTransform = Options.AutoTrans.Value end)

local DropAttackPos = Tabs.Main:AddDropdown("AttackPos", {
    Title = "Attack Position",
    Values = {"Top", "Bottom", "Side"},
    Multi = false,
    Default = "Top",
})
DropAttackPos:OnChanged(function(Value) _G.AttackPosition = Value end)

-- Skill Configuration (Cleaned up)
local SkillMulti = Tabs.Main:AddDropdown("Skills", {
    Title = "Skills to Use",
    Description = "Select skills to spam while attacking",
    Values = {"Z", "X", "C", "B"},
    Multi = true,
    Default = {"Z", "X", "C", "B"},
})
SkillMulti:OnChanged(function(Value)
    _G.UseSkills.Z = Value["Z"]
    _G.UseSkills.X = Value["X"]
    _G.UseSkills.C = Value["C"]
    _G.UseSkills.B = Value["B"]
end)


-- [[ SETTINGS TAB ]] --

Tabs.Settings:AddSlider("SliderDist", {
    Title = "Attack Distance",
    Default = 6, Min = 0, Max = 20, Rounding = 1,
    Callback = function(Value) _G.Height = Value end
})

Tabs.Settings:AddSlider("SliderPatrol", {
    Title = "Patrol Delay",
    Description = "Time to wait after patrol warp to find mobs",
    Default = 2, Min = 1, Max = 5, Rounding = 0.5,
    Callback = function(Value) _G.PatrolDelay = Value end
})

Tabs.Settings:AddButton({
    Title = "Reset Character",
    Callback = function()
        local h = getHumanoid()
        if h then h.Health = 0 end
    end
})

-- [[ MAIN LOGIC LOOP ]] --

task.spawn(function()
    while true do
        if _G.AutoFarm then
            local root = getRoot()
            local hum = getHumanoid()

            if root and hum and hum.Health > 0 then
                
                -- STEP 1: TRANSFORM (Priority)
                -- ถ้าเป็นคน และเปิด Auto Transform ให้แปลงร่างก่อน อย่าเพิ่งไปตี
                if _G.AutoTransform and isHuman() then
                    pressKey(Enum.KeyCode.V) -- Open Omnitrix
                    task.wait(0.3)
                    pressKey(Enum.KeyCode.C) -- Select Alien (C is usually the confirm)
                    task.wait(0.2)
                    -- Spam C to ensure transform
                    for i=1, 3 do pressKey(Enum.KeyCode.C) task.wait(0.1) end
                    task.wait(1.5) -- Wait for animation
                
                else
                    -- STEP 2: FIND TARGET
                    local target = FindClosestTarget()

                    if target and target:FindFirstChild("HumanoidRootPart") then
                        -- STEP 3: WARP & ATTACK
                        local tRoot = target.HumanoidRootPart
                        local newCF
                        
                        -- Calc Position
                        if _G.AttackPosition == "Top" then
                            newCF = CFrame.new(tRoot.Position + Vector3.new(0, _G.Height, 0), tRoot.Position) * CFrame.Angles(math.rad(-90), 0, 0)
                        elseif _G.AttackPosition == "Bottom" then
                            newCF = CFrame.new(tRoot.Position - Vector3.new(0, _G.Height, 0), tRoot.Position) * CFrame.Angles(math.rad(90), 0, 0)
                        else
                            newCF = CFrame.new(tRoot.Position + (tRoot.CFrame.LookVector * -1 * _G.Height), tRoot.Position)
                        end

                        -- Teleport
                        root.CFrame = newCF
                        root.AssemblyLinearVelocity = Vector3.zero 
                        
                        -- Execute Attack & Skills
                        CombatSequence(target)

                    else
                        -- STEP 4: PATROL (If no target found)
                        -- วาปไปจุดเกิด -> รอ -> หาใหม่
                        
                        -- Teleport to current patrol point
                        root.CFrame = spawnPoints[currentPatrolIndex]
                        root.AssemblyLinearVelocity = Vector3.zero
                        
                        -- IMPORTANT: Wait for mobs to render/load
                        task.wait(_G.PatrolDelay) 
                        
                        -- Check if we found something AFTER warping
                        local checkTarget = FindClosestTarget()
                        if not checkTarget then
                            -- Only move index if we STILL don't see anything
                            currentPatrolIndex = currentPatrolIndex + 1
                            if currentPatrolIndex > #spawnPoints then currentPatrolIndex = 1 end
                        end
                    end
                end
            end
        end
        task.wait() -- Very fast tick for smoothness
    end
end)

-- [[ NOCLIP (To prevent falling through floor during farm) ]]
RunService.Stepped:Connect(function()
    if _G.AutoFarm then
        local char = player.Character
        if char then
            for _, v in pairs(char:GetChildren()) do
                if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
            end
        end
    end
end)

-- // Finialize
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
Window:SelectTab(1)

Fluent:Notify({
    Title = "Ben 10 Fixed",
    Content = "Merged Logic Loaded. Press Auto Farm.",
    Duration = 5
})
