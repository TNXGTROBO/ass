--[[
    Ben 10 Mobile Optimized Script [Smart Equip & Patrol Fix]
    UI: Orion (Original)
    Logic: Added 7-Point Patrol System
]]

-- รอให้เกมโหลดเสร็จ
if not game:IsLoaded() then
    game.Loaded:Wait()
end
task.wait(2)

print("Starting Script...")

-- // Load Library (Orion เดิม)
local success, OrionLib = pcall(function()
    return loadstring(game:HttpGet(('https://raw.githubusercontent.com/shlexware/Orion/main/source')))()
end)

if not success or not OrionLib then
    OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/jensonhirst/Orion/main/source"))()
end

local Window = OrionLib:MakeWindow({
    Name = "Ben 10 Fix [Patrol & Smart Equip]", 
    HidePremium = false, 
    SaveConfig = true, 
    ConfigFolder = "Ben10Fixv3",
    IntroEnabled = true,
    IntroText = "Patrol Logic Loaded"
})

-- // Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- // Variables & Config
_G.HeightAboveHead = 6
_G.AutoWarpEnabled = false
_G.AutoTransform = false
_G.AttackPosition = "Top"
_G.SmartEquipEnabled = false 
_G.SkillSpam = { Z = false, X = false, C = false, B = false }
_G.SkillSpamEnabled = false
_G.PatrolWaitTime = 2 -- เวลารอที่จุดเกิด (วินาที)

-- // จุดเกิด 7 จุด (Spawn Points) จากสคริปต์ที่สอง
local spawnPoints = {
    CFrame.new(1836.52673, 11.0042171, 361.953735),
    CFrame.new(1175.94763, -6.92456007, 770.222107),
    CFrame.new(2368.13281, 11.4745083, -682.222168),
    CFrame.new(1661.77637, -6.41603184, 136.095627),
    CFrame.new(2361.77368, -5.41125679, -1042.40613),
    CFrame.new(2092.01367, -58.9112663, 459.680176),
    CFrame.new(2372.37354, -58.9112625, -865.803833)
}
local currentPatrolIndex = 1
local lastPatrolTime = 0

-- Pattern มอนสเตอร์
local mobPatterns = {
    "ROBOTINVASIONEVENT", 
    "AMBIENT_MUGGING", 
    "AMBIENT_ROBBERY", 
    "AMBIENT_TETRA_BRAWL",
    "Criminal", 
    "DNAlien",  
    "Knight",
    "Satis"
}

-- // Helper Functions
local function pressKeyReal(keyCode)
    pcall(function()
        VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
        task.wait(0.05)
        VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
    end)
end

local function getCombatHandler()
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return nil, nil end
    local handler = backpack:FindFirstChild("CombatHandler")
    if handler then
        return handler:FindFirstChild("Attack"), handler:FindFirstChild("Combat") and handler.Combat:FindFirstChild("Animations")
    end
    return nil, nil
end

local function getRoot()
    return player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

-- ฟังก์ชันหาเป้าหมาย
local function FindTarget()
    local closest = nil
    local maxDist = 3000 
    local root = getRoot()
    if not root then return nil end

    for _, folder in pairs(Workspace:GetChildren()) do
        if folder:IsA("Model") and folder:FindFirstChild("HumanoidRootPart") and folder:FindFirstChild("Humanoid") and folder.Humanoid.Health > 0 then
            local name = folder.Name
            for _, pattern in ipairs(mobPatterns) do
                if string.find(name, pattern) or string.match(name, pattern) then
                     local dist = (root.Position - folder.HumanoidRootPart.Position).Magnitude
                     if dist < maxDist then
                         maxDist = dist
                         closest = folder
                     end
                end
            end
        end
    end
    return closest
end

-- // NoClip System
RunService.Stepped:Connect(function()
    if _G.AutoWarpEnabled then
        local char = player.Character
        if char then
            for _, part in pairs(char:GetChildren()) do
                if part:IsA("BasePart") and part.CanCollide then
                    part.CanCollide = false
                end
            end
        end
    end
end)

-- // Logic Loops

-- Skill Spam
task.spawn(function()
    while true do
        if _G.SkillSpamEnabled then
            local target = FindTarget()
            local root = getRoot()
            if target and root and (root.Position - target.HumanoidRootPart.Position).Magnitude < 50 then
                if _G.SkillSpam.Z then pressKeyReal(Enum.KeyCode.Z) end
                if _G.SkillSpam.X then pressKeyReal(Enum.KeyCode.X) end
                if _G.SkillSpam.C then pressKeyReal(Enum.KeyCode.C) end
                if _G.SkillSpam.B then pressKeyReal(Enum.KeyCode.B) end
            end
        end
        task.wait(0.5)
    end
end)

-- Smart Auto Equip
task.spawn(function()
    while true do
        if _G.SmartEquipEnabled then
            local char = player.Character
            if char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
                local currentTool = char:FindFirstChildWhichIsA("Tool")
                if not currentTool then
                    local backpack = player:FindFirstChild("Backpack")
                    if backpack then
                        local toolToEquip = backpack:FindFirstChildWhichIsA("Tool")
                        if toolToEquip then
                            char.Humanoid:EquipTool(toolToEquip)
                        end
                    end
                end
            end
        end
        task.wait(1)
    end
end)

-- Auto Transform
task.spawn(function()
    while true do
        if _G.AutoTransform then
            local char = player.Character
            if char and (char:GetAttribute("Alien") == "Human" or not char:GetAttribute("Alien")) then
                pressKeyReal(Enum.KeyCode.V)
                task.wait(2.5) 
                pressKeyReal(Enum.KeyCode.C)
                task.wait(0.2)
                pressKeyReal(Enum.KeyCode.C)
                task.wait(6)
            end
        end
        task.wait(1)
    end
end)

-- Auto Attack
task.spawn(function()
    while true do
        if _G.AutoWarpEnabled then
            local target = FindTarget() -- เช็คก่อนว่ามีเป้าหมายไหมค่อยตี
            if target then
                local atk, anims = getCombatHandler()
                if atk then
                    pcall(function()
                        atk:FireServer("Attack", false, anims)
                        atk:FireServer("HeavyAttack", false, anims)
                    end)
                else
                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
                    task.wait(0.05)
                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                end
            end
        end
        task.wait(0.15)
    end
end)

-- ** ส่วนที่แก้ไขใหม่: Auto Warp + Patrol Logic **
task.spawn(function()
    while true do
        if _G.AutoWarpEnabled then
            local root = getRoot()
            local target = FindTarget()
            
            if root then
                if target and target:FindFirstChild("HumanoidRootPart") then
                    -- [[ กรณีเจอเป้าหมาย: วาร์ปไปตีตามปกติ ]] --
                    local mobRoot = target.HumanoidRootPart
                    local finalCF
                    
                    if _G.AttackPosition == "Top" then
                        finalCF = CFrame.new(mobRoot.Position + Vector3.new(0, _G.HeightAboveHead, 0), mobRoot.Position) * CFrame.Angles(math.rad(-90), 0, 0)
                    elseif _G.AttackPosition == "Bottom" then
                        finalCF = CFrame.new(mobRoot.Position - Vector3.new(0, _G.HeightAboveHead, 0), mobRoot.Position) * CFrame.Angles(math.rad(90), 0, 0)
                    elseif _G.AttackPosition == "Side" then
                        local backPos = mobRoot.CFrame * CFrame.new(0, 0, _G.HeightAboveHead)
                        finalCF = CFrame.lookAt(backPos.Position, mobRoot.Position)
                    end
                    
                    if finalCF then
                        root.CFrame = finalCF
                        root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                    end
                else
                    -- [[ กรณีไม่เจอเป้าหมาย: เข้าโหมด Patrol (วนจุดเกิด) ]] --
                    if tick() - lastPatrolTime > _G.PatrolWaitTime then
                        -- วาร์ปไปจุดเกิดปัจจุบัน
                        root.CFrame = spawnPoints[currentPatrolIndex]
                        root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                        
                        -- อัปเดตเวลาและลำดับ
                        lastPatrolTime = tick()
                        currentPatrolIndex = currentPatrolIndex + 1
                        if currentPatrolIndex > #spawnPoints then
                            currentPatrolIndex = 1
                        end
                    end
                end
            end
        end
        -- ใช้ task.wait เล็กน้อยเพื่อไม่ให้กินทรัพยากรมากเกินไป แต่ยังวาร์ปเนียน
        task.wait() 
    end
end)

-- // UI SETUP (Orion Original)
local MainTab = Window:MakeTab({ Name = "Auto Farm", Icon = "rbxassetid://4483345998", PremiumOnly = false })

MainTab:AddToggle({
    Name = "Auto Warp + Kill (with Patrol)",
    Default = false,
    Callback = function(Value) _G.AutoWarpEnabled = Value end    
})

MainTab:AddDropdown({
    Name = "Attack Position",
    Default = "Top",
    Options = {"Top", "Bottom", "Side"},
    Callback = function(Value) _G.AttackPosition = Value end    
})

MainTab:AddSlider({
    Name = "Distance", Min = 0, Max = 20, Default = 6, Increment = 1, ValueName = "Studs",
    Callback = function(Value) _G.HeightAboveHead = Value end    
})

-- เพิ่ม Slider สำหรับปรับความเร็วในการย้ายจุดเกิด
MainTab:AddSlider({
    Name = "Patrol Wait Time", Min = 0, Max = 10, Default = 2, Increment = 0.5, ValueName = "Secs",
    Callback = function(Value) _G.PatrolWaitTime = Value end,
    Description = "Time to wait at each spawn point if no mobs found"
})

local CombatTab = Window:MakeTab({ Name = "Combat & Items", Icon = "rbxassetid://4483345998", PremiumOnly = false })

CombatTab:AddToggle({
    Name = "Auto Smart Equip Tool", 
    Default = false, 
    Callback = function(Value) _G.SmartEquipEnabled = Value end,
    Description = "Automatically finds and holds your weapon/watch"
})

CombatTab:AddToggle({ Name = "Enable Skills", Default = false, Callback = function(v) _G.SkillSpamEnabled = v end })
CombatTab:AddToggle({ Name = "Auto Z", Default = false, Callback = function(v) _G.SkillSpam.Z = v end })
CombatTab:AddToggle({ Name = "Auto X", Default = false, Callback = function(v) _G.SkillSpam.X = v end })
CombatTab:AddToggle({ Name = "Auto C", Default = false, Callback = function(v) _G.SkillSpam.C = v end })
CombatTab:AddToggle({ Name = "Auto B", Default = false, Callback = function(v) _G.SkillSpam.B = v end })
CombatTab:AddToggle({ Name = "Auto Transform", Default = false, Callback = function(v) _G.AutoTransform = v end })

local MiscTab = Window:MakeTab({ Name = "Misc", Icon = "rbxassetid://4483345998", PremiumOnly = false })

MiscTab:AddButton({
    Name = "Reset Character",
    Callback = function()
         if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.Health = 0
        end
     end    
})

OrionLib:Init()
